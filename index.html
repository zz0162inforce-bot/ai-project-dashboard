<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å°ˆæ¡ˆæˆ°æƒ…å®¤ v27.0 (æ‹–æ›³+è¦–è¦ºå„ªåŒ–)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #f4f7f6;
            --text: #333;
        }

        /* å€å¡Šè‰²ç³» */
        :root {
            --za-bg: #e7f1ff;
            --za-color: #0d6efd;
            --zb-bg: #fff3cd;
            --zb-color: #ffc107;
            --zc-bg: #d1e7dd;
            --zc-color: #198754;
        }

        body {
            background-color: var(--bg);
            font-family: "Microsoft JhengHei", sans-serif;
            padding: 20px;
            color: var(--text);
            padding-bottom: 80px;
        }

        /* å°è¦½åˆ— */
        .navbar {
            background: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-title-input {
            border: none;
            background: transparent;
            font-weight: 800;
            font-size: 1.5rem;
            color: #2c3e50;
            width: 400px;
            outline: none;
            border-bottom: 2px solid transparent;
            transition: 0.2s;
        }

        .nav-title-input:focus {
            border-bottom-color: #0d6efd;
        }

        /* ç”˜ç‰¹åœ–å®¹å™¨ */
        .gantt-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            overflow-x: auto;
        }

        /* å€å¡Šæ¨™é¡Œ */
        .zone-header {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 6px solid #ccc;
            flex-wrap: wrap;
            gap: 10px;
        }

        .theme-A {
            background: var(--za-bg);
            border-color: var(--za-color);
            color: #004085;
        }

        .theme-B {
            background: var(--zb-bg);
            border-color: var(--zb-color);
            color: #856404;
        }

        .theme-C {
            background: var(--zc-bg);
            border-color: var(--zc-color);
            color: #0f5132;
        }

        .zone-title-input {
            border: none;
            background: transparent;
            font-weight: bold;
            font-size: 1.1rem;
            color: inherit;
            width: 250px;
            outline: none;
            border-bottom: 1px dashed transparent;
        }

        .zone-title-input:focus {
            border-bottom-color: currentColor;
        }

        .zone-goal-input {
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.6);
            border-radius: 6px;
            padding: 3px 8px;
            font-size: 0.9rem;
            color: #555;
            font-weight: bold;
            cursor: pointer;
            width: 140px;
        }

        .zone-countdown {
            font-weight: bold;
            font-size: 0.95rem;
            margin-left: 10px;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .btn-zone-action {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            color: #555;
        }

        .btn-del-zone {
            color: #dc3545;
            border-color: #dc3545;
            background: rgba(255, 255, 255, 0.5);
        }

        .btn-add-new-zone {
            width: 100%;
            border: 2px dashed #ccc;
            background: #f8f9fa;
            color: #666;
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            transition: 0.2s;
        }

        .btn-add-new-zone:hover {
            border-color: #0d6efd;
            color: #0d6efd;
            background: #e7f1ff;
        }

        /* ä»»å‹™åˆ—è¡¨å®¹å™¨ (ç”¨æ–¼ Sortable) */
        .zone-task-list {
            min-height: 10px;
            padding-bottom: 10px;
        }

        /* ç”˜ç‰¹åœ–è¡Œ */
        .gantt-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
            background: white;
            transition: background 0.2s;
        }

        .gantt-row:hover {
            background: #fcfcfc;
        }

        /* æ‹–æ›³ä¸­çš„æ¨£å¼ */
        .sortable-ghost {
            opacity: 0.4;
            background: #eee;
        }

        /* æ‹–æ›³æŠŠæ‰‹ */
        .drag-handle {
            width: 30px;
            text-align: center;
            cursor: grab;
            color: #adb5bd;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drag-handle:hover {
            color: #666;
        }

        .row-action {
            width: 30px;
            text-align: center;
            cursor: pointer;
            color: #dc3545;
            font-size: 1.1rem;
            opacity: 0.3;
            transition: 0.2s;
        }

        .row-action:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .gantt-label {
            width: 200px;
            padding-left: 10px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .gantt-label:hover {
            text-decoration: underline;
        }

        .gantt-track {
            flex-grow: 1;
            position: relative;
            height: 26px;
            background: #f8f9fa;
            border-radius: 13px;
            margin: 0 15px;
        }

        .gantt-bar {
            position: absolute;
            height: 100%;
            border-radius: 13px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            padding-left: 12px;
            cursor: help;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            white-space: nowrap;
        }

        .bar-theme-A {
            background: var(--za-color);
        }

        .bar-theme-B {
            background: var(--zb-color);
        }

        .bar-theme-C {
            background: var(--zc-color);
        }

        /* è¦–è¦ºå„ªåŒ–ï¼šåœ“é»é» */
        .dot-indicator {
            display: inline-flex;
            gap: 3px;
            align-items: center;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .dot.filled {
            background: white;
            box-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
        }

        .gantt-countdown {
            width: 120px;
            text-align: right;
            font-size: 0.85rem;
            font-weight: bold;
            color: #666;
            padding-right: 5px;
        }

        .cd-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .cd-normal {
            background: #e9ecef;
            color: #555;
        }

        .cd-urgent {
            background: #ffe6e6;
            color: #dc3545;
        }

        .cd-done {
            background: #d1e7dd;
            color: #198754;
        }

        /* æµ®å‹•å¤§æŒ‰éˆ• */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #333;
            color: white;
            border-radius: 50%;
            border: none;
            font-size: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }
    </style>
</head>

<body>

    <div class="navbar">
        <input type="text" id="nav-title" class="nav-title-input" value="å°ˆæ¡ˆåˆ†å€ç®¡ç† v27.0"
            onchange="saveMainTitle(this.value)">
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="resetData()">â†» é‡ç½®</button>
            <button class="btn btn-sm btn-outline-success" onclick="exportJSON()">ğŸ“¥ å‚™ä»½</button>
            <input type="file" id="importFile" hidden onchange="importJSON(this)">
            <button class="btn btn-sm btn-outline-warning" onclick="document.getElementById('importFile').click()">ğŸ“¤
                é‚„åŸ</button>
        </div>
    </div>

    <div class="gantt-container">
        <div class="d-flex justify-content-between mb-2">
            <h5 class="fw-bold m-0 text-muted">ğŸ—ºï¸ å°ˆæ¡ˆè·¯ç·šåœ– (Roadmap)</h5>
            <small class="text-muted">ğŸ’¡ æ‹–æ›³å·¦å´ â‰¡ å¯æ’åºä»»å‹™ | åœ“é»ä»£è¡¨å­ä»»å‹™å®Œæˆæ•¸</small>
        </div>

        <div id="gantt-chart-area">
        </div>

        <button class="btn-add-new-zone" onclick="addNewZone()">ï¼‹ æ–°å¢å°ˆæ¡ˆå€å¡Š (Add New Zone)</button>
    </div>

    <button class="fab" onclick="createTask()">ï¼‹</button>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">âœï¸ ç·¨è¼¯ä»»å‹™</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="small text-muted fw-bold">æ‰€å±¬å°ˆæ¡ˆå€å¡Š</label>
                        <select id="m-zone" class="form-select border-primary fw-bold bg-light"></select>
                    </div>
                    <label class="small text-muted">ä»»å‹™åç¨±</label>
                    <input type="text" id="m-title" class="form-control mb-3 fw-bold">
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label class="small text-muted">é–‹å§‹æ—¥</label><input type="date" id="m-start"
                                class="form-control"></div>
                        <div class="col-6"><label class="small text-muted">çµæŸæ—¥</label><input type="date" id="m-end"
                                class="form-control"></div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted">é€²åº¦ç‹€æ…‹</label>
                        <select id="m-status" class="form-select">
                            <option value="future">âšª æœªé–‹å§‹</option>
                            <option value="active">ğŸ”µ é€²è¡Œä¸­</option>
                            <option value="done">ğŸŸ¢ å·²å®Œæˆ</option>
                        </select>
                    </div>
                    <hr>
                    <label class="small text-muted fw-bold">å­ä»»å‹™æ¸…å–®</label>
                    <div class="input-group mb-2">
                        <input type="text" id="new-sub" class="form-control" placeholder="è¼¸å…¥ç´°é …..."
                            onkeypress="if(event.key==='Enter') addSub()">
                        <button class="btn btn-outline-secondary" onclick="addSub()">ï¼‹</button>
                    </div>
                    <div id="sub-list" class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary w-100" onclick="saveTask()">ğŸ’¾ å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // é è¨­è³‡æ–™
        const defaultData = {
            projectTitle: "å°ˆæ¡ˆåˆ†å€ç®¡ç† v27.0 (æ‹–æ›³ç‰ˆ)",
            zones: [
                { id: "A", title: "Aå€å¡Š - ä¸­å†  AI æœƒè­°å»³", theme: "A", goal: "2025-12-31" },
                { id: "B", title: "Bå€å¡Š - AI è€ƒç…§æ©Ÿå™¨äºº", theme: "B", goal: "2025-12-20" },
                { id: "C", title: "Cå€å¡Š - æ±å³æ¨™ç±¤æ¨¡å‹", theme: "C", goal: "2026-01-15" }
            ],
            tasks: [
                { id: "t1", zone: "A", title: "M1 åŸºç¤æ¶æ§‹ (Infra)", start: "2025-11-20", end: "2025-11-30", status: "done", subtasks: [{ txt: "VMç”³è«‹", done: true }, { txt: "é˜²ç«ç‰†", done: true }] },
                { id: "t2", zone: "A", title: "SSO é©—è­‰é–‹ç™¼", start: "2025-12-01", end: "2025-12-15", status: "active", subtasks: [{ txt: "APIæ–‡ä»¶", done: true }, { txt: "Tokenæ¸¬è©¦", done: false }, { txt: "å£“åŠ›æ¸¬è©¦", done: false }] },
                { id: "t3", zone: "B", title: "è€ƒç…§é¡Œåº« PDF æ¸…æ´—", start: "2025-11-25", end: "2025-12-05", status: "active", subtasks: [{ txt: "OCRè­˜åˆ¥", done: true }] }
            ]
        };

        let state = JSON.parse(localStorage.getItem('ai_zone_v27')) || defaultData;
        // ç¢ºä¿æ¯å€‹ä»»å‹™éƒ½æœ‰å”¯ä¸€ ID (èˆŠè³‡æ–™å‡ç´šç”¨)
        state.tasks.forEach(t => { if (!t.id) t.id = 'task_' + Math.random().toString(36).substr(2, 9); });

        let curTaskId = null;
        const modal = new bootstrap.Modal(document.getElementById('editModal'));

        // --- å·¥å…·: å·¥ä½œå¤© ---
        function getBusinessDaysLeft(endDateStr) {
            if (!endDateStr) return null;
            let today = new Date(); today.setHours(0, 0, 0, 0);
            let end = new Date(endDateStr); end.setHours(23, 59, 59, 999);
            if (today > end) return -1;
            let count = 0; let curr = new Date(today);
            while (curr <= end) {
                let d = curr.getDay(); if (d !== 0 && d !== 6) count++; curr.setDate(curr.getDate() + 1);
            }
            return count;
        }

        // --- æ¸²æŸ“ ---
        function render() {
            document.getElementById('nav-title').value = state.projectTitle;
            const container = document.getElementById('gantt-chart-area');
            container.innerHTML = '';

            const minDate = new Date("2025-11-15").getTime();
            const maxDate = new Date("2026-02-28").getTime();
            const totalDur = maxDate - minDate;

            state.zones.forEach(zone => {
                const zTheme = zone.theme || "A";
                // é€™è£¡ä¸ä½¿ç”¨ sortï¼Œå› ç‚ºæˆ‘å€‘å¸Œæœ›æŒ‰ç…§ state.tasks è£¡çš„è‡ªç„¶é †åº (å³ä½¿ç”¨è€…æ‹–æ›³å¾Œçš„é †åº)
                // ä½†æˆ‘å€‘éœ€è¦éæ¿¾å‡ºå±¬æ–¼æ­¤ zone çš„ tasks
                const zTasks = state.tasks.filter(t => t.zone === zone.id);
                const zGoal = zone.goal || "";

                let goalHtml = "";
                if (zGoal) {
                    const days = getBusinessDaysLeft(zGoal);
                    if (days < 0) goalHtml = `<span class="zone-countdown text-danger">âš ï¸ å·²æˆªæ­¢</span>`;
                    else goalHtml = `<span class="zone-countdown text-success">â³ å‰© ${days} å·¥ä½œå¤©</span>`;
                } else {
                    goalHtml = `<span class="zone-countdown text-muted">æœªè¨­æ—¥æœŸ</span>`;
                }

                // 1. å€å¡Šæ¨™é¡Œ
                container.innerHTML += `
                <div class="zone-header theme-${zTheme}">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <input type="text" class="zone-title-input" value="${zone.title}" onchange="updateZoneTitle('${zone.id}', this.value)">
                        <input type="date" class="zone-goal-input" value="${zGoal}" onchange="updateZoneGoal('${zone.id}', this.value)">
                        ${goalHtml}
                    </div>
                    <div>
                        <button class="btn-zone-action" onclick="createTask('${zone.id}')">ï¼‹ ä»»å‹™</button>
                        <button class="btn-zone-action btn-del-zone ms-1" onclick="deleteZone('${zone.id}')">Ã—</button>
                    </div>
                </div>
            `;

                // 2. ä»»å‹™åˆ—è¡¨å®¹å™¨ (åŠ ä¸Š ID æ–¹ä¾¿ Sortable)
                const listId = `zone-list-${zone.id}`;
                let listHtml = `<div id="${listId}" class="zone-task-list" data-zone="${zone.id}">`;

                if (zTasks.length === 0) {
                    listHtml += `<div class="text-center text-muted small py-3 dashed">å°šç„¡ä»»å‹™</div>`;
                } else {
                    zTasks.forEach(t => {
                        const s = new Date(t.start).getTime();
                        const e = new Date(t.end).getTime();
                        let left = ((s - minDate) / totalDur) * 100;
                        let width = ((e - s) / totalDur) * 100;
                        if (left < 0) { width += left; left = 0; }
                        if (width < 2) width = 2;

                        // è¦–è¦ºå„ªåŒ–ï¼šåœ“é» (Dots)
                        let dotsHtml = '<div class="dot-indicator">';
                        t.subtasks.forEach(sub => {
                            dotsHtml += `<div class="dot ${sub.done ? 'filled' : ''}"></div>`;
                        });
                        if (t.subtasks.length === 0) dotsHtml += '<span style="font-size:0.7rem; opacity:0.7">ç„¡ç´°é …</span>';
                        dotsHtml += '</div>';

                        // Tooltip
                        const pendingItems = t.subtasks.filter(sb => !sb.done).map(sb => "â€¢ " + sb.txt).join("\n");
                        const tooltipTxt = pendingItems ? `å¾…è¾¦ï¼š\n${pendingItems}` : "âœ… å…¨æ•¸å®Œæˆ";

                        // å€’æ•¸
                        let daysLeftHtml = '';
                        if (t.status === 'done') daysLeftHtml = `<span class="cd-tag cd-done">å®Œæˆ</span>`;
                        else {
                            const days = getBusinessDaysLeft(t.end);
                            if (days < 0) daysLeftHtml = `<span class="cd-tag bg-secondary text-white">æˆªæ­¢</span>`;
                            else if (days <= 3) daysLeftHtml = `<span class="cd-tag cd-urgent">å‰© ${days} å¤©</span>`;
                            else daysLeftHtml = `<span class="cd-tag cd-normal">å‰© ${days} å¤©</span>`;
                        }

                        // æ³¨æ„ï¼š data-id å­˜ä»»å‹™ IDï¼Œæ–¹ä¾¿æ’åºæ›´æ–°
                        listHtml += `
                        <div class="gantt-row" data-id="${t.id}">
                            <div class="drag-handle">â‰¡</div>
                            <div class="row-action" onclick="quickDelete('${t.id}')">ğŸ—‘ï¸</div>
                            <div class="gantt-label" onclick="openEdit('${t.id}')" title="${t.title}">${t.title}</div>
                            <div class="gantt-track">
                                <div class="gantt-bar bar-theme-${zTheme}" 
                                     style="left:${left}%; width:${width}%;"
                                     onclick="openEdit('${t.id}')"
                                     title="${tooltipTxt}">
                                     ${dotsHtml}
                                </div>
                            </div>
                            <div class="gantt-countdown">${daysLeftHtml}</div>
                        </div>
                    `;
                    });
                }
                listHtml += `</div>`;
                container.innerHTML += listHtml;
            });

            // æ¸²æŸ“å¾Œï¼Œé‡æ–°ç¶å®š Sortable
            initSortable();
            localStorage.setItem('ai_zone_v27', JSON.stringify(state));
        }

        // --- æ‹–æ›³æ’åºé‚è¼¯ ---
        function initSortable() {
            state.zones.forEach(zone => {
                const el = document.getElementById(`zone-list-${zone.id}`);
                if (el) {
                    new Sortable(el, {
                        handle: '.drag-handle', // åªèƒ½æ‹‰æŠŠæ‰‹
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: function (evt) {
                            // æ‹–æ›³çµæŸï¼Œæ›´æ–° state.tasks çš„é †åº
                            const zoneId = evt.item.parentElement.getAttribute('data-zone');
                            updateOrder(zoneId, evt.from);
                        }
                    });
                }
            });
        }

        function updateOrder(zoneId, containerEl) {
            // 1. å–å¾—è©²å€å¡Šç›®å‰ DOM è£¡çš„ ID é †åº
            const newIds = Array.from(containerEl.querySelectorAll('.gantt-row')).map(el => el.getAttribute('data-id'));

            // 2. æŠŠåŸæœ¬ tasks æ‹†æˆã€Œæ­¤å€å¡Šã€èˆ‡ã€Œéæ­¤å€å¡Šã€
            const otherTasks = state.tasks.filter(t => t.zone !== zoneId);
            const zoneTasksMap = new Map(state.tasks.filter(t => t.zone === zoneId).map(t => [t.id, t]));

            // 3. ä¾ç…§æ–° ID é †åºé‡çµ„æ­¤å€å¡Šçš„ tasks
            const reorderedZoneTasks = newIds.map(id => zoneTasksMap.get(id)).filter(t => t); // filter undefined just in case

            // 4. åˆä½µ (ç‚ºäº†ä¿æŒå…¶ä»–å€å¡Šä¸å—å½±éŸ¿ï¼Œæˆ‘å€‘å…ˆæ”¾ reorderedï¼Œå†æ”¾ othersï¼Œæˆ–è€…åä¹‹çš†å¯ï¼Œé€™è£¡æ¡å–ç°¡å–®åˆä½µ)
            // æ›´åš´è¬¹çš„åšæ³•ï¼šæ‡‰è©²ä¿æŒ zones çš„ç›¸å°é †åºã€‚ä½†å› ç‚ºæˆ‘å€‘æ¸²æŸ“æ˜¯ä¾è³´ zones é™£åˆ—ï¼Œtasks é™£åˆ—çš„çµ•å°é †åºåªå½±éŸ¿åŒ zone å…§çš„æ’åºã€‚
            // æ‰€ä»¥ï¼Œæˆ‘å€‘åªè¦æŠŠæ­¤ zone çš„ tasks æŠ½æ‰ï¼Œæ›æˆæ–°çš„é †åºæ’å›å»å³å¯ã€‚

            // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘ç›´æ¥ï¼šéæ­¤å€å¡Š + æ­¤å€å¡Š(æ–°é †åº)
            // ä½†é€™æ¨£æœƒå°è‡´æ­¤å€å¡Šè·‘åˆ°æœ€å¾Œé¢å—ï¼Ÿä¸ï¼Œå› ç‚º render æ˜¯è·‘ zones è¿´åœˆã€‚tasks é™£åˆ—é †åºåªå½±éŸ¿ filter å¾Œçš„çµæœã€‚
            // æ‰€ä»¥åªè¦ filter å‡ºä¾†çš„é †åºæ˜¯å°çš„å°±å¥½ã€‚

            // æ›´æ–° state
            state.tasks = [...otherTasks, ...reorderedZoneTasks];

            // å­˜æª” (ä¸ç”¨ re-renderï¼Œå› ç‚º DOM å·²ç¶“å‹•äº†)
            localStorage.setItem('ai_zone_v27', JSON.stringify(state));
        }


        // --- å€å¡Šèˆ‡ä»»å‹™åŸºæœ¬æ“ä½œ ---
        function saveMainTitle(val) { state.projectTitle = val; localStorage.setItem('ai_zone_v27', JSON.stringify(state)); }
        function updateZoneTitle(id, val) { const z = state.zones.find(z => z.id === id); if (z) { z.title = val; render(); } }
        function updateZoneGoal(id, val) { const z = state.zones.find(z => z.id === id); if (z) { z.goal = val; render(); } }

        function addNewZone() {
            const lastTheme = state.zones.length > 0 ? state.zones[state.zones.length - 1].theme : "C";
            let newTheme = lastTheme === "A" ? "B" : (lastTheme === "B" ? "C" : "A");
            state.zones.push({ id: "Z" + Date.now(), title: "æ–°å°ˆæ¡ˆå€å¡Š", theme: newTheme, goal: "" });
            render();
        }
        function deleteZone(id) {
            if (confirm("ç¢ºå®šåˆªé™¤æ­¤å€å¡Šèˆ‡å…¶ä¸‹ä»»å‹™ï¼Ÿ")) {
                state.zones = state.zones.filter(z => z.id !== id);
                state.tasks = state.tasks.filter(t => t.zone !== id);
                render();
            }
        }

        function createTask(zoneKey) {
            const defaultZone = zoneKey || (state.zones.length > 0 ? state.zones[0].id : "");
            if (!defaultZone) { alert("è«‹å…ˆæ–°å¢å€å¡Š"); return; }
            const newId = 'task_' + Date.now();
            state.tasks.push({ id: newId, zone: defaultZone, title: "æ–°ä»»å‹™...", start: new Date().toISOString().split('T')[0], end: new Date().toISOString().split('T')[0], status: "future", subtasks: [] });
            openEdit(newId);
        }

        function quickDelete(id) { if (confirm("åˆªé™¤ä»»å‹™ï¼Ÿ")) { state.tasks = state.tasks.filter(t => t.id !== id); render(); } }

        function openEdit(id) {
            curTaskId = id;
            const t = state.tasks.find(t => t.id === id);
            if (!t) return;

            const zoneSelect = document.getElementById('m-zone');
            zoneSelect.innerHTML = state.zones.map(z => `<option value="${z.id}">${z.title}</option>`).join('');
            zoneSelect.value = t.zone;

            document.getElementById('m-title').value = t.title;
            document.getElementById('m-start').value = t.start;
            document.getElementById('m-end').value = t.end;
            document.getElementById('m-status').value = t.status;
            renderSubs();
            modal.show();
        }

        function saveTask() {
            const t = state.tasks.find(t => t.id === curTaskId);
            if (t) {
                t.zone = document.getElementById('m-zone').value;
                t.title = document.getElementById('m-title').value;
                t.start = document.getElementById('m-start').value;
                t.end = document.getElementById('m-end').value;
                t.status = document.getElementById('m-status').value;
            }
            modal.hide();
            render();
        }

        function renderSubs() {
            const t = state.tasks.find(t => t.id === curTaskId);
            const list = document.getElementById('sub-list');
            list.innerHTML = t.subtasks.map((s, i) => `
            <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                <div class="d-flex align-items-center">
                    <input type="checkbox" class="form-check-input me-2" ${s.done ? 'checked' : ''} onchange="toggleSub(${i})">
                    <span class="${s.done ? 'text-decoration-line-through text-muted' : ''}">${s.txt}</span>
                </div>
                <button class="btn btn-sm text-danger p-0" onclick="delSub(${i})">Ã—</button>
            </div>
        `).join('');
        }
        function addSub() {
            const val = document.getElementById('new-sub').value;
            if (val) {
                const t = state.tasks.find(t => t.id === curTaskId);
                t.subtasks.push({ txt: val, done: false });
                document.getElementById('new-sub').value = '';
                renderSubs();
            }
        }
        function delSub(i) {
            const t = state.tasks.find(t => t.id === curTaskId);
            t.subtasks.splice(i, 1);
            renderSubs();
        }
        function toggleSub(i) {
            const t = state.tasks.find(t => t.id === curTaskId);
            t.subtasks[i].done = !t.subtasks[i].done;
            renderSubs();
        }

        function resetData() { if (confirm("é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.removeItem('ai_zone_v27'); location.reload(); } }
        function exportJSON() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(state)], { type: "application/json" })); a.download = "AI_Zone_v27.json"; a.click(); }
        function importJSON(el) { const r = new FileReader(); r.onload = e => { try { state = JSON.parse(e.target.result); render(); alert("ok"); } catch { alert("error"); } }; if (el.files[0]) r.readAsText(el.files[0]); }

        render();
    </script>

</body>


</html>
